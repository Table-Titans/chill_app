{% set session_data = session|default({}) %}
{% set course_data = course if course is defined and course else session_data.get('course') %}
{% set location_data = location if location is defined and location else session_data.get('location') %}

{% if attendees is defined %}
    {% set attendee_data = attendees %}
{% elif session_data.get('attendee_list') is not none %}
    {% set attendee_data = session_data.get('attendee_list') %}
{% else %}
    {% set attendee_data = session_data.get('attendees') %}
{% endif %}

{% set description_text = session_data.get('description') or (description if description is defined else None) %}
{% set notes_text = session_data.get('notes') or (notes if notes is defined else None) %}
{% set organizer_name = session_data.get('organizer') or (organizer if organizer is defined else None) %}
{% set start_value = session_data.get('start_time') or (start_time if start_time is defined else None) %}
{% set end_value = session_data.get('end_time') or (end_time if end_time is defined else None) %}

{% set course_title = course_data.title if course_data and course_data.title is defined and course_data.title else session_data.get('course_name') %}
{% set course_section = course_data.section if course_data and course_data.section is defined and course_data.section else (session_data.get('section') or session_data.get('course_section')) %}
{% set course_year = course_data.year if course_data and course_data.year is defined and course_data.year is not none else (session_data.get('year') if session_data.get('year') is not none else session_data.get('course_year')) %}
{% set course_term = course_data.term if course_data and course_data.term is defined and course_data.term is not none else (session_data.get('term') if session_data.get('term') is not none else session_data.get('course_term')) %}
{% set professor_name = course_data.professor_name if course_data and course_data.professor_name is defined and course_data.professor_name else session_data.get('professor_name') %}

{% set term_lookup = {1: "Fall", 2: "Spring", 3: "Summer", 4: "Winter"} %}
{% set display_title = session_data.get('title') or (course_title if course_title else "Study Session Details") %}
{% set room_type_info = session_data.get('room_type') %}
{% set session_tags = session_data.get('tags') or [] %}
{% set session_resources = session_data.get('resources') or [] %}
{% set session_reminders = session_data.get('reminders') or [] %}
{% set is_organizer = session_data.get('organizer', '') is string and 'you' in session_data.get('organizer', '').lower() %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ display_title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    {% include "partials/navbar.html" %}

    {% set location_info = location_data %}
    {% set location_ns = namespace(label="", map_query="") %}

    {% if location_info %}
        {% if location_info is string %}
            {% set location_ns.label = location_info %}
            {% set location_ns.map_query = location_info %}
        {% elif location_info is mapping %}
            {% set address = location_info.get('address') %}
            {% set room = location_info.get('room_number') %}
            {% if address %}
                {% set location_ns.label = address %}
                {% set location_ns.map_query = address %}
            {% endif %}
            {% if room %}
                {% set location_ns.label = (location_ns.label ~ " - Room " ~ room) if location_ns.label else room %}
                {% set location_ns.map_query = (location_ns.map_query ~ " " ~ room) if location_ns.map_query else room %}
            {% endif %}
        {% endif %}
    {% endif %}

    {% if not location_ns.label %}
        {% set address = session_data.get('address') %}
        {% set room = session_data.get('room_number') %}
        {% if address %}
            {% set location_ns.label = address %}
            {% set location_ns.map_query = address %}
        {% endif %}
        {% if room %}
            {% set location_ns.label = (location_ns.label ~ " - Room " ~ room) if location_ns.label else room %}
            {% set location_ns.map_query = (location_ns.map_query ~ " " ~ room) if location_ns.map_query else room %}
        {% endif %}
    {% endif %}

    {% if not location_ns.label and session_data.get('location_name') %}
        {% set location_ns.label = session_data.get('location_name') %}
        {% set location_ns.map_query = session_data.get('location_name') %}
    {% endif %}

    {% if not location_ns.label and session_data.get('location') %}
        {% set location_ns.label = session_data.get('location') %}
        {% set location_ns.map_query = session_data.get('location') %}
    {% endif %}
    <div class="form-container session-details">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flash-messages">
                    {% for category, message in messages %}
                        <li class="flash {{ category }}">{{ message }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}
        <a href="{{ url_for('home') }}" class="back-btn">← Back to dashboard</a>
        <div class="session-header">
            <h1 class="session-title">
                {{ session_data.title if session_data.title is defined and session_data.title else "Study Session Overview" }}
                {% if session_data.chill_level is defined and session_data.chill_level %}
                    <span>{{ session_data.chill_level }}</span>
                {% endif %}
            </h1>
            <p class="session-subtitle">
                {{ course_title if course_title else "Stay on track with the full session details" }}
            </p>
            {% if session_tags %}
                <div class="session-tag-group">
                    {% for tag in session_tags %}
                        <span class="tag-pill">{{ tag.tag_name|title }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="session-summary-grid">
            <div class="summary-card">
                <span class="summary-label">Organizer</span>
                <span class="summary-value">{{ organizer_name or "TBD" }}</span>
            </div>
            <div class="summary-card">
                <span class="summary-label">Start Time</span>
                <span class="summary-value">{{ start_value or "TBD" }}</span>
            </div>
            <div class="summary-card">
                <span class="summary-label">End Time</span>
                <span class="summary-value">{{ end_value or "TBD" }}</span>
            </div>
            <div class="summary-card">
                <span class="summary-label">Location</span>
                <span class="summary-value">{{ location_ns.label or "Location coming soon" }}</span>
            </div>
            <div class="summary-card">
                <span class="summary-label">Room Type</span>
                <span class="summary-value">
                    {% if room_type_info %}
                        {{ room_type_info.type_name }}
                    {% else %}
                        TBD
                    {% endif %}
                </span>
            </div>
        </div>

        <div class="session-sections">
            <div class="session-card">
                <h2 class="session-section-title">Notes &amp; Description</h2>
                {% if description_text %}
                    <p>{{ description_text }}</p>
                {% else %}
                    <p>No detailed description has been added yet.</p>
                {% endif %}
                {% if notes_text %}
                    <p class="notes-highlight">{{ notes_text }}</p>
                {% endif %}
            </div>

            <div class="session-card">
                <h2 class="session-section-title">Session Resources</h2>
                {% if session_resources %}
                    <ul class="resource-list">
                        {% for resource in session_resources %}
                            <li>
                                <a href="{{ resource.resource_url }}" target="_blank" rel="noopener">
                                    {{ resource.resource_name }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No resources uploaded yet.</p>
                {% endif %}
                {% if is_organizer %}
                    <form method="POST"
                          action="{{ url_for('upload_session_resource', session_id=session_data.id) }}"
                          enctype="multipart/form-data"
                          class="resource-upload-form">
                        <label for="resource_file_upload_{{ session_data.id }}">Add a new resource (txt or pdf)</label>
                        <input type="file"
                               id="resource_file_upload_{{ session_data.id }}"
                               name="resource_file"
                               accept=".txt,.pdf"
                               required>
                        <button type="submit" class="submit-btn">Upload Resource</button>
                        <small>The upload creates a placeholder CDN link until storage is ready.</small>
                    </form>
                {% endif %}
            </div>

            <div class="session-card">
                <h2 class="session-section-title">Email Reminder</h2>
                {% if session_reminders %}
                    <ul class="reminder-list">
                        {% for reminder in session_reminders %}
                            <li>
                                <strong>{{ reminder.display_time or reminder.reminder_time }}</strong>
                                – {{ "Sent" if reminder.reminder_sent else "Pending" }}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No email reminders scheduled yet.</p>
                {% endif %}
            </div>

            <div class="session-card">
                <h2 class="session-section-title">Course Information</h2>
                <div class="course-grid">
                    <div class="course-row">
                        <span class="course-label">Course Name</span>
                        <span class="course-value">
                            {{ course_title if course_title else "N/A" }}
                        </span>
                    </div>
                    <div class="course-row">
                        <span class="course-label">Term</span>
                        <span class="course-value">
                            {% if course_term is not none %}
                                {{ term_lookup.get(course_term, course_term) }}
                            {% else %}
                                N/A
                            {% endif %}
                        </span>
                    </div>
                    <div class="course-row">
                        <span class="course-label">Section</span>
                        <span class="course-value">
                            {{ course_section if course_section else "N/A" }}
                        </span>
                    </div>
                    <div class="course-row">
                        <span class="course-label">Year</span>
                        <span class="course-value">
                            {{ course_year if course_year is not none else "N/A" }}
                        </span>
                    </div>
                    <div class="course-row">
                        <span class="course-label">Professor</span>
                        <span class="course-value">
                            {{ professor_name if professor_name else "N/A" }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="session-card">
                <h2 class="session-section-title">Space Details</h2>
                {% if room_type_info %}
                    <p><strong>{{ room_type_info.type_name }}</strong></p>
                    <p>{{ room_type_info.description }}</p>
                {% else %}
                    <p>The room type for this session has not been set yet.</p>
                {% endif %}
            </div>

            <div class="session-card map-card">
                <h2 class="session-section-title">Where to Meet</h2>
                {% if location_ns.map_query %}
                    <iframe class="map-frame" loading="lazy" allowfullscreen
                        src="https://www.google.com/maps?q={{ location_ns.map_query | urlencode }}&amp;output=embed"></iframe>
                {% else %}
                    <div class="map-placeholder">Map preview will appear here once the location is finalized.</div>
                {% endif %}
            </div>

            <div class="session-card attendees-card">
                <h2 class="session-section-title">Attendees</h2>
                {% if attendee_data %}
                    {% if attendee_data is number %}
                        <p>{{ attendee_data }} attendee{{ '' if attendee_data == 1 else 's' }} currently registered.</p>
                    {% elif attendee_data is string %}
                        <p>{{ attendee_data }}</p>
                    {% elif attendee_data is mapping %}
                        <div class="notes-highlight">
                            {% for key, value in attendee_data.items() %}
                                <p><strong>{{ key }}:</strong> {{ value }}</p>
                            {% endfor %}
                        </div>
                    {% elif attendee_data is iterable %}
                        <ul class="attendee-list">
                            {% for attendee in attendee_data %}
                                {% if attendee is mapping %}
                                    {% set attendee_name = attendee.name if attendee.name is defined and attendee.name else (attendee.get('name') if attendee.get is defined else '') %}
                                    {% set attendee_role = attendee.role if attendee.role is defined and attendee.role else (attendee.get('role') if attendee.get is defined else '') %}
                                    <li>
                                        {{ attendee_name or "Attendee" }}
                                        {% if attendee_role %}
                                            – {{ attendee_role }}
                                        {% endif %}
                                    </li>
                                {% else %}
                                    <li>{{ attendee }}</li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No attendees listed yet.</p>
                    {% endif %}
                {% else %}
                    <p>No attendees have joined this session yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</body>
</html>
